<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8" />
    <title>Pico Editor</title>
    <link rel="stylesheet" href="{{ base_url }}/plugins/yoctophoto/pico_editor.css" type="text/css" />
    <meta name="robots" content="noindex, nofollow" />
  </head>
  <body>
    <div id="saving">Saving...</div>
    <div id="medias">
      <div class="page">
        <h2>Media</h2>
        <script id="img-tpl" type="text/nano-template">
          <li data-page="{page}" data-name="{name}" data-url="{{ base_url }}/{dir}{name}">
            <a href="#" class="link img" title="Insert link">
              <img src="{{ base_url }}/{dir}{name}" />
              <span class="name">{name}</span>
            </a>
            <a href="#" class="view" title="View image">5</a>
            <a href="#" class="rename" title="Rename image">T</a>
            <a href="#" class="delete" title="Delete">4</a>
          </li>
        </script>
        <script id="file-tpl" type="text/nano-template">
          <li data-page="{page}" data-name="{name}" data-url="{{ base_url }}/{dir}{name}">
            <a href="#" class="link file" title="Insert link">
              <span class="file">F</span>
              <span class="name">{name}</span>
            </a>
            <a href="#" class="view" title="Download">D</a>
            <a href="#" class="rename" title="Rename image">T</a>
            <a href="#" class="delete" title="Delete">4</a>
          </li>
        </script>
        <script id="load-tpl" type="text/nano-template">
          <li class="loading" data-id="{id}">
            <a href="#" class="link file" title="Uploading ...">
              <span class="file">F</span>
              <span>{name}</span>
            </a>
            <div class="bar"></div>
          </li>
        </script>
        <ul>
          <!-- The files go here -->
        </ul>
        <div id="upload">
          <input id="fileupload" type="file" name="medias[]" data-url="{{ base_url }}/admin/media/new" multiple />
        </div>
        <div class="progress">
          <div class="bar" style="width: 0%;"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="sidebar">
    <div class="controls">
      <a href="#" class="new btn" title="New">1</a>
      <a href="{{ base_url }}/admin/logout" class="logout btn" title="Logout">2</a>
    </div>
    <ul class="nav">
      {% for page in pages %}
      <!--<li><a href="#" data-url="{{ page.url }}" class="post"><span data-icon="3" aria-hidden="true"></span>{% if page.title %}{{ page.title }}{% else %}Untitled{% endif %}</a>-->
      <li><a href="#" data-url="{{ page.url }}" class="post"><span data-icon="3" aria-hidden="true"></span>{{ page.url }}</a>
      <a href="{{ page.url }}" target="_blank" class="view" title="View">5</a>
      <a href="#" data-url="{{ page.url }}" class="media" title="Media Manager">8</a>
      <a href="#" data-url="{{ page.url }}" class="delete" title="Delete">4</a></li>
      {% endfor %}
    </ul>
  </div>

  <div id="main">
    <div id="epiceditor"></div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="{{ base_url }}/plugins/yoctophoto/epiceditor/js/epiceditor.min.js"></script>
    <script src="{{ base_url }}/plugins/yoctophoto/fileupload/js/vendor/jquery.ui.widget.js"></script>
    <script src="{{ base_url }}/plugins/yoctophoto/fileupload/js/jquery.iframe-transport.js"></script>
    <script src="{{ base_url }}/plugins/yoctophoto/fileupload/js/jquery.fileupload.js"></script>
    <script src="{{ base_url }}/plugins/yoctophoto/nano/jquery.nano.js"></script>

    <!--
    <script src="{{ base_url }}/plugins/yoctophoto/jstree/jstree.min.js"></script>
    -->
    <script>
      $(document).ready(function() {

        var unsaved = false;
        var editor = new EpicEditor({
          container: 'epiceditor',
          basePath: '{{ base_url }}/plugins/yoctophoto/epiceditor',
          clientSideStorage: false,
          file: {
            name: 'epiceditor',
            defaultContent: '',
            autoSave: 5000
          },
          theme: {
            base: '/themes/base/epiceditor.css',
            preview: '/themes/preview/github.css',
            editor: '/themes/editor/epic-light.css'
          },
          button: {
            preview: true,
            fullscreen: false
          },
          focusOnLoad: true
        }).load();

        $(editor.getElement('editor')).on('keyup', function (){
          if(!unsaved){
            unsaved = true;
            document.title += ' *';
          }
        });

        // New
        $('.controls .new').on('click', function(e){
          e.preventDefault();
          var dir = prompt('Please enter the dir(path without host and page/file name)', '/');
          var title = prompt('Please enter a post title', '');
          if(title != null && title != '' && dir != null && dir != ''){
            $.post('admin/new', { title: title, dir: dir }, function(data){
              if(data.error){
                alert(data.error);
                } else {
                $('.nav .post').removeClass('open');
                $('#epiceditor').data('currentFile', data.file);
                editor.importFile('epiceditor', data.content);
                unsaved = false;
                document.title = document.title.replace(' *', '');
                $('.nav').prepend('<li><a href="#" data-url="{{ base_url }}/'+ data.file +'" class="post open"><span data-icon="3" aria-hidden="true"></span>'+ data.title +'</a><a href="{{ base_url }}/'+ data.file +'" target="_blank" class="view" title="View">5</a><a href="#" data-url="{{ base_url }}/'+ data.file +'" class="delete" title="Delete">4</a></li>')
              }
            }, 'json');
          }
        });

        // Open post
        $('.nav').on('click', '.post', function(e){
          e.preventDefault();
          if(unsaved && !confirm('You have unsaved changes. Are you sure you want to leave this post?')) return false;
          $('.nav .post').removeClass('open');
          $(this).addClass('open');

          var fileUrl = $(this).attr('data-url');
          $.post('admin/open', { file: fileUrl }, function(data){
            $('#epiceditor').data('currentFile', fileUrl);
            editor.importFile('epiceditor', data);
            unsaved = false;
            document.title = document.title.replace(' *', '');
          });
        });

        // Save post
        editor.on('autosave', function () {
          $('#saving').text('Saving...').addClass('active');
          $.post('admin/save', { file: $('#epiceditor').data('currentFile'), content: editor.exportFile() }, function(data){
            $('#saving').text('Saved');
            unsaved = false;
            document.title = document.title.replace(' *', '');
            setTimeout(function(){
              $('#saving').removeClass('active');
            }, 1000);
          });
        });

        // Save on preview
        editor.on('preview', function () {
          editor.emit('autosave');
        });

        // Delete post
        $('.nav').on('click', '.delete', function(e){
          e.preventDefault();
          if(!confirm('Are you sure you want to delete this file?')) return false;
          $('.nav .post').removeClass('open');

          var li = $(this).parents('li');
          var fileUrl = $(this).attr('data-url');
          $.post('admin/delete', { file: fileUrl }, function(data){
            li.remove();
            $('#epiceditor').data('currentFile', '');
            editor.importFile('epiceditor', '');
            unsaved = false;
            document.title = document.title.replace(' *', '');
          });
        });

        // Media actions
        var mediaAction = function(event){
          if(event) event.preventDefault();
          // the dom elements
          $link = $(this);
          var p = $link.parent();

          if($link.hasClass('link')){
            // insert link in current document
            editor.getElement('editor').body.innerHTML += '<br />[Awesome link](' + p.data('url') + ')<br />';
            if(!unsaved){
              unsaved = true;
              document.title += ' *';
            }

            // we go back to the editor
            $('#medias').fadeOut('slow');

          } else if($link.hasClass('view')) {
            // open target in new window
            window.open(p.data('url'));

          } else if($link.hasClass('rename')) {
            // rename file
            var newName = prompt('Enter the new file name:', p.data('name'));
            var nameCheck = /[a-zA-Z0-9-_. ()]+/i;
            if(nameCheck.test(newName) && newName.length > 3){
              var oldName = p.data('name');
              $.post('admin/media/rename', {
                file: p.data('page'),
                oldName: oldName,
                newName: newName
                }, function(data){
                console.log('Rename data: ' + data);
                if(data == 'Success'){
                  // effective renaming
                  p.data('name', newName);
                  p.data('url', p.data('url').replace(oldName, newName));
                  p.find('.name').text(newName);
                }
              });
            }

          } else if($link.hasClass('delete')){
            // delete file
            if(!confirm('Are you sure you want to delete this file?')) return false;
            $.post('admin/media/delete', {
              file: p.data('page'),
              name: p.data('name')
            }, function(data){
              if(data == 'Success'){
                // delete in UI
                p.remove();
              }
            });

          } else {
            // invalid link?
          }
        };

        // Reloading the content
        var reload = function(currentUrl){
          if(!currentUrl) currentUrl = $('#medias').data('url');
          // empty list
          var $list = $('#medias ul');
          $list.empty();
          // get file list
          $.post('{{ base_url }}/admin/media/list', { file: currentUrl },
          function(data) {
            $.each(data.list, function(index, file){
              var json = {
                name: file,
                page: data.file,
                dir: data.dir
              };
              var imgExt = /.+\.(png|jpe?g|gif)$/i;
              var tmpl = imgExt.test(file) ? '#medias #img-tpl' : '#medias #file-tpl';
              $res = $(tmpl).nanotmpl(json);
              $res.find('a').click(mediaAction);
              $res.appendTo($list);
            });
          }, 'json');
        };

        // Open media
        $('.nav').on('click', '.media', function(e){
          e.preventDefault();
          var currentUrl = $(this).attr('data-url');
          $('#medias').data('url', currentUrl).fadeIn('slow');
          reload(currentUrl);
        });
        $('#medias').click(function(event){
          if($(event.target).attr('id') == 'medias'){
            $(this).fadeOut('slow');
          }
        });

        // Upload
        var fileCount = 0;
        var fileDone = 0;
        $('#fileupload').fileupload({
          dataType: 'json'
        }).bind('fileuploadchange', function(e, data){ // FILE CHANGE ---------
          // we update the file count
          fileCount = data.files.length;

        }).bind('fileuploadadd', function(e, data) { // QUEUE ADD -------------
          // we add the "loading" item template
          $('#medias #load-tpl').nanotmpl({
            name: data.files[0].name,
            id: data.files[0].name
          }).appendTo($('#medias ul'));

        }).bind('fileuploadsubmit', function(e, data) { // SUBMIT -------------
          data.formData = {
            file: $('#medias').data('url')
          };

        }).bind('fileuploadprogress', function(e, data) { // PROGRESS ---------
          var progress = parseInt(data.loaded / data.total * 100, 10);
          var id = data.files[0].name;
          $('#medias li.loading').filter(function(){
            return $(this).data('id') == id;
          }).find('.bar').css('width', progress + '%');

        }).bind('fileuploadprogressall', function(e, data) { // PROGRESSALL ---
          var progress = parseInt(data.loaded / data.total * 100, 10);
          $('#medias .progress').fadeIn('slow');
          $('#medias .progress .bar').css('width', progress + '%');

        }).bind('fileuploaddone', function(e, data) { // DONE -----------------
          // TODO take care of failure cases
          // (look at data.result or data.textStatus != 'success')
          // increment done counter
          ++fileDone;
          if(fileDone >= fileCount) {
            // hide if we're fully done, and reload everything
            $('#medias .progress').fadeOut('slow', reload);
          } else {
            if(data.result && data.result.medias){
              var file = data.result.medias[0];
              if(file){
                $('#medias li.loading').filter(function(){
                  return $(this).data('id') == file.name;
                }).removeClass('loading').find('.bar').remove();
              }
            }
          }
        });

        // Window resize
        $('body,#main,#epiceditor').height($(window).height());
        $(window).resize(function() {
          $('body,#main,#epiceditor').height($(window).height());
          editor.reflow();
        });

      });
    </script>
  </div>

</body>
</html>
